<!DOCTYPE html>
<!--
  ~ Copyright 2017 OverStory Ltd <copyright@overstory.co.uk> and other contributors
  ~ (see the CONTRIBUTORS file).
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>MarkLogic Run Config Help</title>
	</head>
	<body>
		<h2>MarkLogic Run/Debug Modes</h2>
		<p>
			The radio buttons here select the mode by which XQuery should be executed on MarkLogic.
			There are four modes, the first two of which apply to both Run and Debug.  The second two
			only apply to debugging.
		</p>
		<p>
			These modes are:
		</p>
		<p></p>

		<h3>Ad Hoc (eval)</h3>
			<p>
				The content of the selected file, which must be a main module, will be sent to MarkLogic
				and executed as an Ad Hoc query using <code>dbg:eval</code>.  External variables may be passed to the query.
				Library modules may only be imported if they exist in the path of the appserver (the module's effective path
				will be the appserver root).  Library modules in the IntelliJ workspace will not automatically be visible at runtime.
			</p>
			<p>
				This mode runs requests on the TaskServer rather than the configured appserver.  This means that
				no output will ever be produced.  This is necessary to be able to run and debug a request from the
				appserver.  If you need to see the output as well as debug, user the Capture Appserver mode.
			</p>
			<p>
				Requests running on the TaskServer will also not be able to see any HTTP request values.  This will ony be
				possible with the Capture Appserver mode.  The same applies to Invoke mode.
			</p>
			<p></p>

		<h3>Invoke</h3>
			<p>
				The selected module will be invoked by URI, determined by the selected XQuery file.  The
				content of the selected file will <i>not</i> be sent to MarkLogic.  The module will be invoked
				by name via the appservers root path.
			</p>
			<p>
				This option only works properly if MarkLogic's appserver is configured
				to have its root point at a directory within the IntelliJ workspace.  By telling the MarkLogic
				plugin where the appserver root is, it can adjust the relative paths so that the IntelliJ
				can see the source when stopped at a breakpoint.
			</p>
			<p>
				This mode runs requests on the Task Server rather than the configured appserver.  This means that
				no output will ever be produced.  This is necessary to be able to run and debug a request from the
				same appserver.  If you need to see the output as well as debug a request, user the Capture Appserver mode.
			</p>
			<p></p>

		<h3>Capture AppServer</h3>
			<p>
				This run mode "grabs" an appserver (specified either by name, appserver id or port number).  It then waits for the
				next request to start on that appserver.  When it does, the request will be halted for debugging just before
				the first expression.  If no expression starts on the captured appserver within the timeout period (configurable
				in seconds, default 120) then the debugger will quit and release the appserver.
			</p>

			<p>
				Any output created will be sent to the captured app server, not the debugging run window.
				Note however that because of the way requests run on MarkLogic, any output produced will only be sent when the
				query request completes without error.  To see information as the request is stepped through the debugger,
				consider using <code>xdmp:log</code> calls and tailing the MarkLogic server ErrorLog.txt.
			</p>

			<p>
				This run mode is useful for debugging code "in-situ", running in its native environment, rather than on the Task Server.
				In some cases, such as when the code being debugged depends on HTTP parameters, this is the only way to debug the code.
				It is useful for tracing REST endpoints, for example.  It can also capture XCC requests from Java/.Net applications.
			</p>

			<p>
				To use this mode and run the code from IntelliJ create two Run Configurations. One with a
				DataSource to run the XQuery code on the desired appserver, the other to capture that appserver (configured to
				run on a different DataSource port).  Run the second (Capture Appserver) configuration in Debug mode and wait for
				it to say that it's waiting.
				Then run the first one (using Run mode) to start the request.  The debugger tab should pop to the front when the new
				request starts and you can step it from there.  Any output produced by the request will go to the Run tab.
			</p>
			<p>
				<b>Note:</b> It is important that the appserver referenced in the DataSource (not the one to be captured) be configured
				so that its appserver root points to the code being debugged, and that the Appserver Root path be set properly in the
				run configuration so that IntelliJ's filesystem paths can be mapped from MarkLogic's appserver-relative paths.  If IntelliJ
				cannot find the source file on disk, then the debug runner will hang when a breakpoint is reached.
			</p>

		<h3>Debug Running Request</h3>
			<p>
				Not yet implemented.
			</p>
			<p>
				This mode will provide a means by which a running request may be attached to and stepped with the debugger.
				To work successfully, the appserver root path must be set properly, as for Invoke mode.  It is possible to debug code running from
				a Modules Database, but a corresponding source tree must be in this project's workspace with the path of the
				code at the appserver root configured here.  When the debugger stops, if it does not find the corresponding
				source file then it will not work properly.
			</p>
			<p>
				Most requests on MarkLogic run very quickly.  This mode will primarily be useful for diagnosing requests that
				have gotten stuck or are running away.
			</p>
			<p></p>

		<p>&copy; 2017 <a href="http://overstory.co.uk">OverStory Ltd</a></p>
	</body>
</html>
